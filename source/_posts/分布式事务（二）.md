---
title: 分布式事务（二）
date: 2017-05-23 15:51:41
tags:
    - 技术分享
---
# 前言
大约N年前吧，由于公司需要，在`tcc`的基础上设计并实现了分布式事务，保证了业务流程即使在极端恶劣的环境下也可以保证事务的一致。之前曾经去到一个看起来非常nb的互联网公司去面试，面试官问到了分布式事务的问题，当时我就来了兴趣，将自己设计的那套系统搬出来，一五一十的介绍给了那两位面试官（实话说，我觉得那个时候我说话还是很谨慎的，很尊重那两位面试官的）。结果他们居然不理解我的设计，一味重复着我觉得我自己觉得已经解答了的问题。我尝试从多个层面去解释给他们，但是他们似乎并不买账。后来我仔细研究了二阶段提交，明白了原来，这两位面试官只是学院派。
接下来我会用浅显易懂的方式（就是不忽悠），帮助各位落地分布式事务的解决方案。
我将围绕以下几个问题展开讨论
1. 分布式事务问题是如何产生的
2. 业界的解决方案有什么
3. 我的设计方案是什么
4. 更优的设计方案有哪些

这里首先扫个盲

`XA`
XA：XA协议由Tuxedo首先提出的，并交给X/Open组织，作为资源管理器（数据库）与事务管理器的接口标准。目前，Oracle、Informix、DB2和Sybase等各大数据库厂家都提供对XA的支持。XA协议采用两阶段提交方式来管理分布式事务。XA接口提供资源管理器与事务管理器之间进行通信的标准接口。
`ACID`
Atomicity-原子性：一个事务中所有操作都必须全部完成，要么全部不完成。 
Consistency一致性. 在事务开始或结束时，数据库应该在一致状态。 
Isolation隔离层. 事务将假定只有它自己在操作数据库，彼此不知晓。 
Durability. 一旦事务完成，就不能返回。
## 分布式事务问题是如何产生的
### 本地事务
轻量级的事务管理器
### 简单跨库事务
简单跨库事务，简单的说就事务包含了n（n≥2）个库的操作，且操作满足事务的要求ACID【也就是常说的一致性，原子性，持久性】，且该服务可以持有多个库的源。
列个清单：
事务包含n（n≥2）个库的操作
ACID
服务可以持有事务包含的所有数据源
这类事务的解决方案很多，也很简单，大部分关系型数据库都实现了XA，只要有一个事务管理器去调度该应用中各个数据源进行子事务的操作即可。业界典型的实现就是Atomikos

很显然，最后一点决定了它的事务是简单事务，因为在分布式系统中，要求系统是服务化，不可能存在项目是可以持有多个跨领域数据源的。比方说订单服务和库存服务不可能同时存在于一个工程，这个不符合服务化项目的要求

### 跨服务事务（RPC）

