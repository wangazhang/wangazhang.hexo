---
title: 基于dubbo的平滑部署设计
date:  2017-03-28 15:30:57
tags:
---

> 脸谱技术架构经历了从无到有，从单一到多元，从简单到复杂的过程。不过最近大家应该都能深刻的体会到：一直以来我们也未能避免平滑发布这件事。
> 过去我们可能只需要简单的发布一两个服务，就完成了一次发布，但是随着系统的拆分，我们逐步完成了单一系统的拆分，服务化，以及稍后就要动手的微服务拆分，这个过程我们渐渐发现平滑发布的重要性，因为服务已经变成了上百个，而且还在呈现扩张的趋势，过去的这种发布形式若要影响面够小，我们必须停机，这是不能容忍的。

因此这次我们需要对非停机发布下的平滑部署做一个认识。

这里我抛砖引玉，讲解下

# 如何利用dubbo进行平滑部署
这里先提几个概念：灰度测试、平滑部署

## 灰度测试

灰度测试是指在黑与白之间，能够平滑过渡的一种部署方式基础上做的测试。AB test就是一种灰度部署方式，让一部分用户继续用A，一部分用户开始用B，如果用户对B没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到B上面来。
灰度部署可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度。

我们的系统可以通过这几种方式进行灰度

入口灰度、服务灰度、以及数据库灰度

数据库灰度这里不做讨论，业界基本没有完全可行的解决方案（如灰度用户）！

这里讨论的是入口灰度和服务灰度

## 平滑部署

平滑部署，指部署过程不停机即可实现服务的升级，要区别于平滑发布这个概念。
# LET'S START

准备
指定一批（套）服务为灰度发布服务，每次灰度发布时首先更新这批机器
因此要求所有的服务要有备份，即服务必须部署2个以上
如下图示
![](http://onaqzli6n.bkt.clouddn.com/14906834107816.png)

步骤
1. 通过程序统一修改服务的版本号为灰度发布版本号 如0.0.0，区别于1.1.1的正式版本

2. 进行灰度测试

3. 通过灰度测试后，ngnix reload 切换为灰度机器，此时原灰度机器正式对外，且0.0.0被认为是正式版本号，而1.1.1变为下次灰度测试的版本

4. 发布其他被替换下来的服务为新版本并分别上线

5. 剩余face-web的上线

以发布finance为例，尽量简化过程
![](http://onaqzli6n.bkt.clouddn.com/14906835833854.png)

![](http://onaqzli6n.bkt.clouddn.com/14906990399145.png)

![](http://onaqzli6n.bkt.clouddn.com/14906836356449.png)

![](http://onaqzli6n.bkt.clouddn.com/14906837414361.png)

# Q&A：
1. face-web如何切换
根据流量选择部分face-web下线，通过ngnix的reload 动态切换
2. 灰度发布的版本号是多少？
有两个0.0.0 和1.1.1
3. 看起来步骤还是很复杂，有没有简单点的动作完成
首先灰度发布本身就是复杂的内容，想要精简内容已近无可能。
但是从流程上我们可以通过可视化界面，将多个步骤合成，从而简化我们的发布流程，从而缩短发布时间。

4. 使用脚本将预灰度的web服务停止并将新的web服务启动，此时 的web服务版本号与线上服务区分开来
![](http://onaqzli6n.bkt.clouddn.com/14906837414361.png)
    

